# !/bin/sh
echo Initial... 
mkdir -p /usr/local/svas/log
chown -R svas:svas /usr/local/svas
exec 6<&0 0</dev/tty
echo -n Please input the web service port:
read portOfService
echo -n Please input password of root for MYSQL:
read passwordOfRoot
sed -i 's/port\s*:\s*12345/port : '"$portOfService"'/' /usr/local/svas/svas.yml
sed -i 's/password\s*:\s*root/password : '"$passwordOfRoot"'/g' /usr/local/svas/svas.yml
mysql -uroot --host=127.0.0.1 -p$passwordOfRoot < /usr/local/svas/svas.sql

REQ=0
if [ -f /lib64/libmysqlclient.so.20 ]; then 
   REQ=1
else 
   echo Warning!!! File /lib64/libmysqlclient.so.20 not found! Need install mysqllient 5.7 or mysql server 5.7.
   echo            If them installed, check you libaries seek path. 
fi
java -version 2>&1| grep -i -E "(openjdk|openjre|java).*version.*1\.8"
if [ $? -eq 0 ]; then
   if [ REQ -eq 1 ]; then 
      REQ=2
   fi
else
   echo Warning!!! Java 1.8.x or openjdk 1.8.x not found.
fi

systemctl status >/dev/null 2>&1
if [ $? -eq 0 ]; then
	ln -s /%{_unitdir}/%{name}.service /etc/systemd/system/multi-user.target.wants/%{name}.service
	if [ REQ -eq 2 ]; then 
	   systemctl start svas.service
	fi
else
	cp /usr/local/svas/svas.init.d /etc/init.d/svas
	if [ REQ -eq 2 ]; then
	   service svas start
	fi
fi


systemctl status >/dev/null 2>&1
if [ $? -eq 0 ]; then
	rm /usr/local/svas/svas.init.d
	if [ -d /usr/lib/systemd/system ]; then
		cp /usr/local/svas/svas.service /usr/lib/systemd/system/svas.service
		ln -s /usr/lib/systemd/system/svas.service /etc/systemd/system/multi-user.target.wants/svas.service
	else
		cp /usr/local/svas/svas.service /lib/systemd/system/svas.service
		ln -s /lib/systemd/system/svas.service /etc/systemd/system/multi-user.target.wants/svas.service
	fi
	if [ REQ -eq 2 ]; then 
	   systemctl start svas.service
	fi
else
	cp /usr/local/svas/svas.init.d /etc/init.d/svas
	if [ REQ -eq 2 ]; then 
	   service svas start
	fi
fi

